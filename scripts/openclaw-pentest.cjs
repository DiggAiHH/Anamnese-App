#!/usr/bin/env node
/**
 * OpenClaw Pentest Runner — Anamnese-App
 * Runs all security checks defined in .openclaw/prompts/pentest.md
 *
 * Usage: node scripts/openclaw-pentest.cjs [--phase=1|2|3|4|all]
 *
 * @security This script scans for PII leaks and credential exposure.
 */
'use strict';

const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const TIMESTAMP = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
const LOG_DIR = path.join(__dirname, '..', 'buildLogs');
const REPORT_PATH = path.join(LOG_DIR, `pentest_report_${TIMESTAMP}.md`);

// Ensure buildLogs exists
if (!fs.existsSync(LOG_DIR)) fs.mkdirSync(LOG_DIR, { recursive: true });

const args = process.argv.slice(2);
const phase = args.find(a => a.startsWith('--phase='))?.split('=')[1] || 'all';

const findings = { critical: 0, high: 0, medium: 0, low: 0, info: 0 };
const results = [];

function run(cmd, label) {
  try {
    const output = execSync(cmd, { encoding: 'utf-8', cwd: path.join(__dirname, '..'), timeout: 60000 });
    return output;
  } catch (e) {
    return e.stdout || e.stderr || `[ERROR] ${label}: ${e.message}`;
  }
}

function addFinding(severity, category, description, details) {
  findings[severity]++;
  results.push({ severity, category, description, details: details?.trim()?.slice(0, 500) || '' });
}

// ── Phase 1: DSGVO Compliance ──────────────────────────────────────────
function phase1() {
  console.log('[PENTEST] Phase 1: DSGVO Compliance Scan...');

  // 1.1 PII in Logs
  const piiScan = run(
    'grep -rn --include="*.ts" --include="*.tsx" --include="*.js" ' +
    '-E "(console\\.(log|warn|error|info)|logger\\.(info|warn|error|debug))" src/ ' +
    '| grep -iE "(email|password|name|phone|address|ip|birth|patient)" || true',
    'PII Scan'
  );
  if (piiScan.trim()) {
    addFinding('critical', 'DSGVO', 'PII found in logging statements', piiScan);
  } else {
    addFinding('info', 'DSGVO', 'No PII detected in logging statements', 'Clean');
  }

  // 1.2 Hardcoded Credentials
  const secretsScan = run(
    'grep -rn --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" ' +
    '-E "(password|secret|api_key|token|credential)\\s*[:=]\\s*[\'\\"\\"][^\'\\"\\"{]{8,}" . ' +
    '--exclude-dir=node_modules --exclude-dir=.git --exclude-dir=buildLogs ' +
    '--exclude-dir=__tests__ --exclude-dir=__mocks__ || true',
    'Secrets Scan'
  );
  if (secretsScan.trim()) {
    const lines = secretsScan.trim().split('\n').filter(l =>
      !l.includes('mock') && !l.includes('test') && !l.includes('fixture') &&
      !l.includes('package-lock') && !l.includes('.openclaw')
    );
    if (lines.length > 0) {
      addFinding('critical', 'CRA', 'Potential hardcoded credentials', lines.join('\n'));
    } else {
      addFinding('info', 'CRA', 'No hardcoded credentials (test fixtures excluded)', 'Clean');
    }
  } else {
    addFinding('info', 'CRA', 'No hardcoded credentials detected', 'Clean');
  }

  // 1.3 Encryption Standard
  const cryptoAudit = run(
    'grep -rn --include="*.ts" --include="*.js" -E "(ECB|CBC|DES|MD5|SHA1[^-])" src/ shared/ || true',
    'Crypto Audit'
  );
  if (cryptoAudit.trim()) {
    addFinding('high', 'Crypto', 'Weak/deprecated crypto algorithms detected', cryptoAudit);
  } else {
    addFinding('info', 'Crypto', 'No weak crypto algorithms detected', 'Clean');
  }
}

// ── Phase 3: Supply Chain ──────────────────────────────────────────────
function phase3() {
  console.log('[PENTEST] Phase 3: Supply Chain Security...');

  // 3.1 npm Audit
  const auditJson = run('npm audit --json 2>/dev/null || true', 'npm audit');
  const auditPath = path.join(LOG_DIR, `pentest_npm_audit_${TIMESTAMP}.json`);
  fs.writeFileSync(auditPath, auditJson);

  try {
    const audit = JSON.parse(auditJson);
    const vulns = audit.metadata?.vulnerabilities || {};
    const totalVulns = (vulns.critical || 0) + (vulns.high || 0) + (vulns.moderate || 0);
    if (totalVulns > 0) {
      addFinding('high', 'Supply Chain', `npm audit: ${totalVulns} vulnerabilities`,
        `Critical: ${vulns.critical || 0}, High: ${vulns.high || 0}, Moderate: ${vulns.moderate || 0}`);
    } else {
      addFinding('info', 'Supply Chain', 'npm audit: no vulnerabilities', 'Clean');
    }
  } catch {
    addFinding('medium', 'Supply Chain', 'npm audit parse failed', 'Manual review needed');
  }

  // 3.2 Pinned Versions
  const pinCheck = run(
    'node -e "' +
    "const pkg=require('./package.json');" +
    "const deps={...pkg.dependencies,...pkg.devDependencies};" +
    "const unpinned=Object.entries(deps).filter(([,v])=>/[\\^~*]/.test(v)&&!v.startsWith('file:')).map(([k,v])=>k+': '+v);" +
    "if(unpinned.length){console.error('UNPINNED: '+unpinned.join(', '));process.exit(1)}else console.log('All pinned');" +
    '" 2>&1 || true',
    'Pin Check'
  );
  if (pinCheck.includes('UNPINNED')) {
    addFinding('medium', 'CRA', 'Unpinned dependency versions', pinCheck);
  } else {
    addFinding('info', 'CRA', 'All dependency versions pinned', 'Clean');
  }
}

// ── Generate Report ────────────────────────────────────────────────────
function generateReport() {
  const lines = [
    `# Security & Penetration Test Report — ${new Date().toISOString().slice(0, 10)}`,
    '',
    '## Executive Summary',
    `- **Critical**: ${findings.critical}`,
    `- **High**: ${findings.high}`,
    `- **Medium**: ${findings.medium}`,
    `- **Low**: ${findings.low}`,
    `- **Info**: ${findings.info}`,
    '',
    '## Findings',
    '',
    '| # | Severity | Category | Description | Details |',
    '|---|----------|----------|-------------|---------|',
  ];

  results.forEach((r, i) => {
    const detail = r.details.replace(/\n/g, ' ').slice(0, 100);
    lines.push(`| ${i + 1} | ${r.severity.toUpperCase()} | ${r.category} | ${r.description} | ${detail} |`);
  });

  lines.push('', '---', `Generated by openclaw-pentest.cjs at ${new Date().toISOString()}`);

  const report = lines.join('\n');
  fs.writeFileSync(REPORT_PATH, report);
  console.log(`\n[PENTEST] Report saved: ${REPORT_PATH}`);
  console.log(`[PENTEST] Summary: C=${findings.critical} H=${findings.high} M=${findings.medium} L=${findings.low} I=${findings.info}`);

  if (findings.critical > 0) {
    console.error('[PENTEST] ⚠️  CRITICAL findings detected — immediate action required!');
    process.exit(2);
  }
}

// ── Main ───────────────────────────────────────────────────────────────
console.log(`[PENTEST] Anamnese-App Security Scan — Phase: ${phase}`);
console.log(`[PENTEST] Timestamp: ${TIMESTAMP}`);

if (phase === 'all' || phase === '1') phase1();
if (phase === 'all' || phase === '3') phase3();

generateReport();
