# Prompt: Security & Penetration Testing

> Trigger: Weekly automated + pre-release mandatory
> Scope: DSGVO, OWASP, Supply Chain, Code-level security analysis

## Instruction

Agiere als Security Engineer / Penetration Tester für die Anamnese-App.
Diese App verarbeitet medizinische Patientendaten — höchste Sicherheitsstufe.

### ⚠️ SCOPE LIMITATION
- NUR lokale Analyse (kein externes Netzwerk-Pentesting)
- NUR den eigenen Codebase scannen
- KEINE echten Patientendaten verwenden
- Alle Findings in `buildLogs/pentest_*.md` dokumentieren

---

### Phase 1: DSGVO Compliance Scan

**1.1 PII-in-Logs Detection**
```bash
# Suche nach potentiellem PII-Logging
grep -rn --include="*.ts" --include="*.tsx" --include="*.js" \
  -E "(console\.(log|warn|error|info)|logger\.(info|warn|error|debug))" src/ \
  | grep -iE "(email|password|name|phone|address|ip|birth|patient)" \
  > buildLogs/pentest_pii_scan_$(date +%Y%m%d_%H%M%S).log 2>&1 || true
```
→ Jeder Treffer ist ein CRITICAL Finding.

**1.2 Hardcoded Credentials**
```bash
grep -rn --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" \
  -E "(password|secret|api_key|token|credential)\s*[:=]\s*['\"][^'\"]{3,}" . \
  --exclude-dir=node_modules --exclude-dir=.git --exclude-dir=buildLogs \
  > buildLogs/pentest_secrets_scan_$(date +%Y%m%d_%H%M%S).log 2>&1 || true
```
→ Ausnahmen: Test-Fixtures, Mock-Daten (explizit markiert).

**1.3 Encryption Audit**
```bash
# Prüfe Verschlüsselungs-Implementierung
grep -rn --include="*.ts" --include="*.js" \
  -E "(AES|encrypt|decrypt|PBKDF2|SHA|hmac)" src/ shared/ \
  > buildLogs/pentest_crypto_audit_$(date +%Y%m%d_%H%M%S).log 2>&1
```
Checklist:
- [ ] AES-256-GCM (nicht ECB/CBC ohne IV)
- [ ] PBKDF2 >= 600.000 Iterationen
- [ ] Keine statischen IVs/Salts
- [ ] Keychain für Key-Storage (nicht AsyncStorage)

---

### Phase 2: OWASP Mobile Top 10

| # | Risiko | Prüf-Methode |
|---|--------|-------------|
| M1 | Improper Platform Usage | Platform-Capability-Checks vorhanden? |
| M2 | Insecure Data Storage | SQLite encrypted? AsyncStorage für PII? |
| M3 | Insecure Communication | TLS enforced? Certificate Pinning? |
| M4 | Insecure Authentication | Session Tokens sicher? |
| M5 | Insufficient Cryptography | AES-256? Key Rotation? |
| M6 | Insecure Authorization | Role-based Access? |
| M7 | Client Code Quality | Static Analysis (ESLint security rules) |
| M8 | Code Tampering | Integrity Checks? |
| M9 | Reverse Engineering | Obfuscation? ProGuard? |
| M10 | Extraneous Functionality | Debug code in production? |

---

### Phase 3: Supply Chain Security

**3.1 npm Audit**
```bash
npm audit --json > buildLogs/pentest_npm_audit_$(date +%Y%m%d_%H%M%S).json 2>&1
```

**3.2 Dependency License Check**
```bash
npx license-checker --json --production \
  > buildLogs/pentest_licenses_$(date +%Y%m%d_%H%M%S).json 2>&1
```
→ Verboten für Medical: GPL, AGPL (viral licensing)
→ Erlaubt: MIT, Apache-2.0, BSD-2/3-Clause, ISC

**3.3 Pinned Versions**
```bash
# Prüfe ob alle deps exakt gepinnt sind (kein ^, ~, *)
node -e "
const pkg = require('./package.json');
const deps = {...pkg.dependencies, ...pkg.devDependencies};
const unpinned = Object.entries(deps)
  .filter(([,v]) => /[\^~*]/.test(v) && !v.startsWith('file:'))
  .map(([k,v]) => k + ': ' + v);
if (unpinned.length) {
  console.error('UNPINNED:', unpinned.join(', '));
  process.exit(1);
} else {
  console.log('All dependencies pinned.');
}
" 2>&1 | tee buildLogs/pentest_pincheck_$(date +%Y%m%d_%H%M%S).log
```

---

### Phase 4: Web Security (OWASP Top 10 Web)

Nur für Web-Build (`react-native-web`):

```bash
# Build web first
npm run web:build

# Lighthouse Security Audit (wenn Chrome verfügbar)
npx lighthouse http://localhost:8080 \
  --output=json --output-path=buildLogs/pentest_lighthouse_$(date +%Y%m%d_%H%M%S).json \
  --only-categories=best-practices \
  --chrome-flags="--headless --no-sandbox" 2>/dev/null || echo "Lighthouse skipped"
```

---

### Report Template

Erstelle `buildLogs/pentest_report_YYYYMMDD.md`:

```markdown
# Security & Penetration Test Report — {{date}}

## Executive Summary
- **Critical**: {{count}}
- **High**: {{count}}
- **Medium**: {{count}}
- **Low**: {{count}}
- **Info**: {{count}}

## DSGVO Compliance
| Check | Status | Details |
|-------|--------|---------|
| PII in Logs | ✅/❌ | {{details}} |
| Hardcoded Secrets | ✅/❌ | {{details}} |
| Encryption Standard | ✅/❌ | {{details}} |
| Data Minimization | ✅/❌ | {{details}} |
| Right to Deletion | ✅/❌ | {{details}} |

## OWASP Findings
{{findings_table}}

## Supply Chain
| Check | Status |
|-------|--------|
| npm Audit | {{vuln_count}} |
| Licenses | {{status}} |
| Pinned Versions | {{status}} |

## Remediation Plan
| # | Finding | Severity | Fix | ETA |
|---|---------|----------|-----|-----|
```

### Execution Frequency
- **Weekly**: Phase 1 (DSGVO) + Phase 3 (Supply Chain)
- **Pre-Release**: Full (Phase 1-4)
- **On-Demand**: Specific phase as needed

### Einschränkungen
- KEIN aktives Exploitation (nur Detection)
- KEINE echten Patientendaten
- Alle Scans lokal (kein externer Traffic)
- Results sind VERTRAULICH — nur in buildLogs/, nicht committen
